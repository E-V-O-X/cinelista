<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cinelistar ‚Äî Listas</title>

  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 img-src 'self' https://image.tmdb.org data:;
                 script-src 'self' 'unsafe-inline';
                 style-src 'self' 'unsafe-inline';
                 connect-src 'self'">

  <style>
    :root{--bg:#0b0d10;--panel:#13161a;--muted:#8fa1b3;--accent:#36d399;--danger:#e25555;--text:#e6edf3;--baseStar:#3a4755}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial}
    header{position:sticky;top:0;z-index:10;background:rgba(11,13,16,.9);backdrop-filter:saturate(1.4) blur(6px);border-bottom:1px solid #1e2329}
    .wrap{max-width:1100px;margin:0 auto;padding:14px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    nav a{color:var(--muted);text-decoration:none;padding:8px 10px;border-radius:10px}
    nav a.active{color:var(--text);background:#0f1317;border:1px solid #2a323c}
    h1{margin:0;font-size:18px}
    .grid{display:grid;gap:12px}
    .pan{background:var(--panel);border:1px solid #1e2329;border-radius:14px;padding:14px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:8px 12px;border-radius:999px;border:1px solid #2a323c;background:#0f1317;color:var(--text);cursor:pointer}
    .tab.active{border-color:#36d399}
    .list{display:grid;gap:10px}
    .item{display:grid;grid-template-columns:44px 1fr auto;gap:10px;align-items:center;border:1px solid #1e2329;background:#0e1115;border-radius:12px;padding:8px}
    .item img{width:44px;height:66px;border-radius:8px;object-fit:cover;cursor:pointer}
    .title{font-weight:600;cursor:pointer}
    .muted{color:var(--muted)}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid #2a323c;background:#14181c;color:var(--text);font-weight:600;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    .btn-danger{border-color:#a33;background:#2a1517}
    .btn-danger:hover{background:#3a1b1f;border-color:#d44}
    .btn-sm{padding:6px 10px;font-size:12px}
    footer{padding:32px 0;color:#74808c}

    dialog{border:1px solid #2a323c;border-radius:14px;max-width:820px;width:calc(100% - 24px);background:#0e1115;color:var(--text)}
    dialog::backdrop{background:rgba(0,0,0,.6)}
    .modal-head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid #1e2329}
    .modal-body{display:grid;gap:12px;padding:14px}
    .tag{
      display:inline-block;
      padding:6px 10px;
      border:1px solid #2a323c;
      border-radius:999px;
      margin:0 6px 6px 0;
      font-size:12px;
      cursor:pointer;
      background:#14181c;   /* fundo neutro */
      color:#fff;           /* texto branco */
      appearance:none;      /* remove estilo nativo do bot√£o */
      -webkit-appearance:none;
    }
    .tag.person{
      background:#14181c;   /* mant√©m neutro p/ pessoa */
      color:#fff;
      border-color:#2a323c;
    }
    .tag:hover{ filter:brightness(1.07); }

    /* Estrelas (0.5) */
    .stars{display:inline-flex;gap:8px;align-items:center;cursor:pointer}
    .star{font-size:24px;line-height:1;user-select:none;color:#3a4755;cursor:pointer;transition:transform .05s}
    .star.on{color:#36d399}
    .star.half{
      background:linear-gradient(90deg,#36d399 50%, #3a4755 50%);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text
    }
    .star:hover{transform:scale(1.08)}
    
    /* Sess√£o (iguais ao index) */
    #loginBtn, #logoutBtn{
      border: 1px solid #2a323c;
      background: #14181c;
      color: #e6edf3;
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
    }
    #loginBtn:hover, #logoutBtn:hover{ filter: brightness(1.1); }
    #who{ color: var(--muted); }
  </style>
</head>
<body>
  <header>
    <div class="wrap row" style="justify-content:space-between">
      <div class="row">
        <h1>üé¨ Cinelistar</h1>
        <nav class="row">
          <a href="/">Explorar</a>
          <a class="active" href="/listas.html">Listas</a>
        </nav>
      </div>
      <div class="row muted">Modo: <b>single-user</b></div>
      <div id="session" class="row">
        <span id="who" class="muted"></span>
        <button id="loginBtn" type="button" onclick="openAuthModal()">Entrar</button>
        <button id="logoutBtn" style="display:none">Sair</button>
      </div>
    </div>
  </header>

  <main class="wrap grid" style="margin-top:14px">
    <section class="pan grid" style="gap:12px">
      <div class="tabs">
        <button class="tab active" data-tab="fav">‚≠ê Favoritos (<b id="c-fav">0</b>)</button>
        <button class="tab" data-tab="watched">üëÅÔ∏è Assistidos (<b id="c-watched">0</b>)</button>
        <button class="tab" data-tab="watchlist">üìù Watchlist (<b id="c-watchlist">0</b>)</button>
        <span style="flex:1"></span>
        <button id="btnExportWatchlist" class="btn btn-sm">Exportar Watchlist (.txt)</button>
        <button id="btnClear" class="btn btn-danger btn-sm">Limpar tudo</button>
      </div>

      <div id="list" class="list"></div>
    </section>
  </main>

  <footer class="wrap" style="margin-top:20px">
    <div class="row" style="justify-content:space-between">
      <div>Dados de filmes por <a href="https://www.themoviedb.org/" target="_blank" rel="noopener">TMDB</a>. Este produto usa a API do TMDB, mas n√£o √© endossado por ela.</div>
      <div>Feito por <b>Werner</b> ‚Ä¢ Hospedado na Vercel</div>
    </div>
  </footer>

  <!-- Modal (detalhes + estrelas + filtros) -->
  <dialog id="movieModal">
    <div class="modal-head">
      <strong id="mTitle">T√≠tulo</strong>
      <button id="mClose" class="btn">Fechar</button>
    </div>
    <div class="modal-body">
      <div class="row">
        <img id="mPoster" alt="" style="width:180px;height:auto;border-radius:10px;object-fit:cover">
        <div>
          <div id="mMeta" class="muted"></div>
          <div id="mGenres" style="margin-top:6px"></div>
          <div id="mCrew" style="margin-top:8px"></div>
          <div style="margin-top:10px">
            <div class="muted" style="margin-bottom:4px">Sua nota</div>
            <div id="mStars" class="stars"></div>
            <button id="mZero" class="btn btn-danger" style="margin-left:8px">Zerar nota</button>
          </div>
        </div>
      </div>
      <div id="mOverview"></div>
    </div>
  </dialog>

  <script>
    const API = {
      tmdbMovie: (id) => `/api/tmdb/movie?id=${id}`,
      tmdbCredits: (id) => `/api/tmdb/credits?id=${id}`,           // NOVO
    };
    const IMG = (p)=> p ? `https://image.tmdb.org/t/p/w342${p}` : "";
    const STORE_KEY = 'cinelista-store-v1';
    const $ = s => document.querySelector(s);

    function baseStore(){ return {fav:[],watched:[],watchlist:[],ratings:{}}; }
    function getStore(){ try{ const s=JSON.parse(localStorage.getItem(STORE_KEY))||baseStore(); if(!s.ratings) s.ratings={}; return s; }catch{ return baseStore(); } }
    function setStore(s){ localStorage.setItem(STORE_KEY, JSON.stringify(s)); }
    function removeItem(status, id){ const s=getStore(); s[status]=s[status].filter(x=>x.id!==id); setStore(s); render(currentTab); }
    function counts(){ const s=getStore(); return {fav:s.fav.length, watched:s.watched.length, watchlist:s.watchlist.length}; }
    function setCounts(){ const c=counts(); $('#c-fav').textContent=c.fav; $('#c-watched').textContent=c.watched; $('#c-watchlist').textContent=c.watchlist; }
    function setRating(id, val){ const s=getStore(); if(val>0) s.ratings[id]=val; else delete s.ratings[id]; setStore(s); }

    // ===== Estrelas (0.5) =====
    function starsHtml(id){
      const cur = Number(getStore().ratings[id] ?? 0);
      return `<div class="stars" data-id="${id}">
        ${[1,2,3,4,5].map(i=>{
          const cls = cur>=i ? 'on' : (cur>=i-0.5 ? 'half' : '');
          return `<span class="star ${cls}" data-i="${i}">‚òÖ</span>`;
        }).join('')}
      </div>`;
    }

    function row(item){
      return `
        <div class="item" data-id="${item.id}" data-status="${item.status}">
          <img src="${IMG(item.poster_path)}" alt="${item.title}" class="open">
          <div style="display:grid;gap:4px">
            <div class="title open">${item.title}</div>
            ${starsHtml(item.id)}
            <div class="muted">${item.status}</div>
          </div>
          <button class="btn btn-danger btn-sm del">üóëÔ∏è Remover</button>
        </div>`;
    }

    function render(tab){
      const s = getStore();
      const arr = s[tab] || [];
      setCounts();
      $('#list').innerHTML = arr.length ? arr.map(row).join('') : '<div class="muted">Nada por aqui ainda.</div>';
    }

    // Tabs
    let currentTab = 'fav';
    document.addEventListener('click', (e)=>{
      if(e.target.classList.contains('tab')){
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        e.target.classList.add('active');
        currentTab = e.target.dataset.tab;
        render(currentTab);
      }
    });

    // Intera√ß√µes da lista (remover, abrir, estrelas com meia-estrela)
    $('#list').addEventListener('click', async (e)=>{
      const item = e.target.closest('.item'); if(!item) return;
      const id = Number(item.dataset.id);
      const status = item.dataset.status;

      if(e.target.classList.contains('del')){
        removeItem(status, id);
        return;
      }
      if(e.target.classList.contains('open') || e.target.classList.contains('title')){
        showDetails(id);
        return;
      }
      if(e.target.classList.contains('star')){
        const i = Number(e.target.dataset.i);
        const rect = e.target.getBoundingClientRect();
        const leftHalf = (e.clientX - rect.left) < rect.width/2;
        const val = leftHalf ? (i - 0.5) : i;
        setRating(id, val);
        render(currentTab);
        return;
      }
    });

    // Modal (detalhes + cr√©ditos + filtros via redirecionamento)
    let currentModalId = null;
    async function showDetails(id){
      currentModalId = id;
      const [r1, r2] = await Promise.all([ fetch(API.tmdbMovie(id)), fetch(API.tmdbCredits(id)) ]);
      if(!r1.ok) return;
      const m = await r1.json();
      const credits = r2.ok ? await r2.json() : { crew:[] };

      $('#mTitle').textContent = m.title || m.name || 'Filme';
      $('#mPoster').src = IMG(m.poster_path);
      const year = m.release_date ? m.release_date.split('-')[0] : '';
      const runtime = m.runtime ? `${m.runtime} min` : '';
      const rating = (m.vote_average?.toFixed?.(1) ?? '‚Äî');
      $('#mMeta').textContent = [year, runtime, `‚≠ê ${rating}`].filter(Boolean).join(' ‚Ä¢ ');
      $('#mOverview').textContent = m.overview || 'Sem sinopse.';

      // g√™neros clic√°veis ‚Üí redireciona para index com ?genre=
      $('#mGenres').innerHTML = (m.genres||[]).map(g=>`<span class="tag" data-genre="${g.id}">${g.name}</span>`).join('');

      // crew (dire√ß√£o/roteiro/edi√ß√£o) ‚Üí redireciona para index com ?person=&role=
      const crew = credits.crew || [];
      const dir = crew.filter(x=>x.job==='Director');
      const writers = crew.filter(x=>['Screenplay','Writer','Story','Adaptation'].includes(x.job));
      const editors = crew.filter(x=>x.job==='Editor');

      const peopleLine = (label, arr, role) =>
        arr.length ? `<div class="muted"><b>${label}:</b> ${arr.slice(0,6).map(p=>`<button class="tag person" data-person="${p.id}" data-role="${role}">${p.name}</button>`).join(' ')}</div>` : '';

      $('#mCrew').innerHTML = [
        peopleLine('Dire√ß√£o', dir, 'director'),
        peopleLine('Roteiro', writers, 'writer'),
        peopleLine('Edi√ß√£o', editors, 'editor')
      ].join('');

      // estrelas no modal
      const wrap = document.getElementById('mStars');
      wrap.innerHTML = '';
      const cur = Number(getStore().ratings[id] ?? 0);
      for(let i=1;i<=5;i++){
        const s = document.createElement('span');
        s.className = 'star';
        if(cur>=i) s.classList.add('on'); else if(cur>=i-0.5) s.classList.add('half');
        s.textContent = '‚òÖ';
        s.onclick = (e)=>{
          const rect = e.target.getBoundingClientRect();
          const leftHalf = (e.clientX - rect.left) < rect.width/2;
          const val = leftHalf ? (i - 0.5) : i;
          setRating(id, val);
          showDetails(id); // re-render modal
          render(currentTab); // atualiza lista sem recarregar
        };
        wrap.appendChild(s);
      }

      document.getElementById('movieModal').showModal();
    }
    document.getElementById('mClose').onclick = ()=> document.getElementById('movieModal').close();
    document.getElementById('movieModal').addEventListener('click', (e)=>{
      if(e.target.dataset.genre){
        const gid = e.target.dataset.genre;
        location.href = `/?genre=${gid}`;  // abre index filtrado
      }
      if(e.target.dataset.person){
        const pid = e.target.dataset.person;
        const role = e.target.dataset.role;
        location.href = `/?person=${pid}&role=${role}`; // abre index filtrado
      }
    });
    document.getElementById('mZero').onclick = ()=>{
      if(currentModalId){ setRating(currentModalId, 0); showDetails(currentModalId); render(currentTab); }
    };

    // Exportar apenas a Watchlist como .txt
    document.getElementById('btnExportWatchlist').onclick = ()=>{
      const s = getStore();
      const lines = (s.watchlist||[]).map(x => `- ${x.title}`);
      const blob = new Blob([lines.join('\n')], {type:'text/plain;charset=utf-8'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'watchlist.txt'; a.click();
    };

    // Limpar tudo
    document.getElementById('btnClear').onclick = ()=>{
      if(confirm('Apagar todas as listas e notas locais?')){
        setStore(baseStore()); render(currentTab);
      }
    };

    // Init
    (function(){ render(currentTab); })();
  </script>

  <script>
    const SESSION = { user: null };
    async function api(path, opts={}) {
      const r = await fetch(path, { credentials: "include", ...opts });
      return r;
    }
    async function whoami() {
      const r = await api("/api/auth/me");
      const j = await r.json();
      SESSION.user = j.user;
      updateSessionUI();
      return SESSION.user;
    }
    function updateSessionUI() {
      const w = document.getElementById("who");
      const inBtn = document.getElementById("loginBtn");
      const outBtn = document.getElementById("logoutBtn");
      if (SESSION.user) {
        w.textContent = `Logado como @${SESSION.user.username}`;
        inBtn.style.display = "none"; outBtn.style.display = "";
      } else {
        w.textContent = "N√£o logado";
        inBtn.style.display = ""; outBtn.style.display = "none";
      }
    }
    async function loadServerStore() {
      const r = await api("/api/lists");
      if (!r.ok) return;
      const { data } = await r.json();
      if (data) {
        localStorage.setItem(STORE_KEY, JSON.stringify(data));
      } else {
        await saveServerStore();
      }
    }
    let saveTimer;
    async function saveServerStore() {
      if (!SESSION.user) return;
      clearTimeout(saveTimer);
      saveTimer = setTimeout(async ()=>{
        try {
          await api("/api/lists", {
            method: "PUT",
            headers: { "content-type": "application/json" },
            body: JSON.stringify({ data: getStore() })
          });
        } catch {}
      }, 250);
    }
    
    // Hook: toda vez que setStore for chamado, tamb√©m salva no servidor
    const _setStoreReal = setStore;
    setStore = function(s){ _setStoreReal(s); saveServerStore(); };
    
    // >>>>>> ALTERADO: bindAuthUI robusto e enviando JSON
    (function bindAuthUI(){
      const openBtn = document.getElementById("loginBtn");
      const closeBtn = document.getElementById("authClose");
      const doLogin = document.getElementById("doLogin");
      const doRegister = document.getElementById("doRegister");
      const msg = document.getElementById("authMsg");
  
      // Abrir modal (pega o elemento na hora do clique, independente da ordem no HTML)
      openBtn?.addEventListener("click", ()=>{
        msg.textContent = "";
        const m = document.getElementById("authModal");
        if (m?.showModal) m.showModal(); else m?.setAttribute("open","");
      });
  
      // Fechar modal
      closeBtn?.addEventListener("click", ()=>{
        const m = document.getElementById("authModal");
        if (m?.close) m.close(); else m?.removeAttribute("open");
      });
  
      // Login (AGORA COM content-type JSON)
      doLogin?.addEventListener("click", async (ev)=>{
        ev.preventDefault();
        msg.textContent = "Entrando...";
        const u = document.getElementById("authUser").value.trim();
        const p = document.getElementById("authPass").value.trim();
        const r = await api("/api/auth/login", {
          method:"POST",
          headers:{ "content-type":"application/json" },
          body: JSON.stringify({ username: u, password: p })
        });
        const j = await r.json();
        if (!r.ok) { msg.textContent = j.error || "Erro ao entrar"; return; }
        const m = document.getElementById("authModal"); m?.close?.();
        await whoami();
        await loadServerStore();
        if (typeof render === "function") render(currentTab || "fav");
      });
  
      // Registrar (AGORA COM content-type JSON)
      doRegister?.addEventListener("click", async ()=>{
        msg.textContent = "Registrando...";
        const u = document.getElementById("authUser").value.trim();
        const p = document.getElementById("authPass").value.trim();
        const r = await api("/api/auth/register", {
          method:"POST",
          headers:{ "content-type":"application/json" },
          body: JSON.stringify({ username: u, password: p })
        });
        const j = await r.json();
        if (!r.ok) { msg.textContent = j.error || "Erro ao registrar"; return; }
        const m = document.getElementById("authModal"); m?.close?.();
        await whoami();
        await loadServerStore();
        if (typeof render === "function") render(currentTab || "fav");
      });
  
      document.getElementById("logoutBtn")?.addEventListener("click", async ()=>{
        await api("/api/auth/logout", { method: "POST" });
        SESSION.user = null;
        updateSessionUI();
      });
    })();

    function openAuthModal() {
      const m   = document.getElementById('authModal');
      const msg = document.getElementById('authMsg');
      if (!m) return;
      if (msg) msg.textContent = '';
      if (typeof m.showModal === 'function') m.showModal();
      else m.setAttribute('open', ''); // fallback se <dialog> n√£o suportar showModal
    }
  
    // (opcional) garantir o fechar
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('authClose')?.addEventListener('click', () => {
        const m = document.getElementById('authModal');
        if (m?.close) m.close(); else m?.removeAttribute('open');
      });
    });
    
    // Inicializa sess√£o
    whoami().then(async (u)=>{ if(u) await loadServerStore(); });
</script>
  
    <dialog id="authModal">
    <form id="authForm" method="dialog" style="display:grid;gap:10px;min-width:280px">
      <h3>Entrar / Registrar</h3>
      <input id="authUser" placeholder="usu√°rio (3-32, a-z 0-9 . _)" />
      <input id="authPass" type="password" placeholder="senha (6+)" />
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="doLogin">Entrar</button>
        <button id="doRegister" type="button">Registrar</button>
        <button id="authClose" type="button">Fechar</button>
      </div>
      <div id="authMsg" class="muted"></div>
    </form>
  </dialog>
  
</body>
</html>
