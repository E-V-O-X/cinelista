<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cinelista ‚Äî Listas</title>

  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 img-src 'self' https://image.tmdb.org data:;
                 script-src 'self' 'unsafe-inline';
                 style-src 'self' 'unsafe-inline';
                 connect-src 'self'">

  <style>
    :root{--bg:#0b0d10;--panel:#13161a;--muted:#8fa1b3;--accent:#36d399;--text:#e6edf3}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial}
    header{position:sticky;top:0;z-index:10;background:rgba(11,13,16,.9);backdrop-filter:saturate(1.4) blur(6px);border-bottom:1px solid #1e2329}
    .wrap{max-width:1100px;margin:0 auto;padding:14px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    nav a{color:var(--muted);text-decoration:none;padding:8px 10px;border-radius:10px}
    nav a.active{color:var(--text);background:#0f1317;border:1px solid #2a323c}
    h1{margin:0;font-size:18px}
    .grid{display:grid;gap:12px}
    .pan{background:var(--panel);border:1px solid #1e2329;border-radius:14px;padding:14px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:8px 12px;border-radius:999px;border:1px solid #2a323c;background:#0f1317;color:var(--text);cursor:pointer}
    .tab.active{border-color:#36d399}
    .list{display:grid;gap:10px}
    .item{display:flex;gap:10px;align-items:center;border:1px solid #1e2329;background:#0e1115;border-radius:12px;padding:8px}
    .item img{width:44px;height:66px;border-radius:8px;object-fit:cover;cursor:pointer}
    .title{font-weight:600;cursor:pointer}
    .muted{color:var(--muted)}
    .pill{padding:6px 8px;border-radius:999px;border:1px solid #2a323c;background:#0f1317;font-size:12px;cursor:pointer}
    .danger{border-color:#603a3a}
    footer{padding:32px 0;color:#74808c}

    dialog{border:1px solid #2a323c;border-radius:14px;max-width:720px;width:calc(100% - 24px);background:#0e1115;color:var(--text)}
    dialog::backdrop{background:rgba(0,0,0,.6)}
    .modal-head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid #1e2329}
    .modal-body{display:grid;gap:12px;padding:14px}
    .tag{display:inline-block;padding:4px 8px;border:1px solid #2a323c;border-radius:999px;margin-right:6px;font-size:12px}
  </style>
</head>
<body>
  <header>
    <div class="wrap row" style="justify-content:space-between">
      <div class="row">
        <h1>üé¨ Cinelista</h1>
        <nav class="row">
          <a href="/">Explorar</a>
          <a class="active" href="/listas.html">Listas</a>
        </nav>
      </div>
      <div class="row muted">Modo: <b>single-user</b></div>
    </div>
  </header>

  <main class="wrap grid" style="margin-top:14px">
    <section class="pan grid" style="gap:12px">
      <div class="tabs">
        <button class="tab active" data-tab="fav">‚≠ê Favoritos (<b id="c-fav">0</b>)</button>
        <button class="tab" data-tab="watched">üëÅÔ∏è Assistidos (<b id="c-watched">0</b>)</button>
        <button class="tab" data-tab="watchlist">üìù Watchlist (<b id="c-watchlist">0</b>)</button>
        <span style="flex:1"></span>
        <button id="btnExport" class="pill">Exportar JSON</button>
        <label class="pill" style="display:flex;align-items:center;gap:6px;cursor:pointer">Importar JSON <input id="fileImport" type="file" accept="application/json" style="display:none"></label>
        <button id="btnClear" class="pill danger">Limpar tudo</button>
      </div>

      <div id="list" class="list"></div>
    </section>
  </main>

  <footer class="wrap" style="margin-top:20px">
    <div class="row" style="justify-content:space-between">
      <div>Dados de filmes por <a href="https://www.themoviedb.org/" target="_blank" rel="noopener">TMDB</a>. Este produto usa a API do TMDB, mas n√£o √© endossado por ela.</div>
      <div>Feito por EVOX ‚Ä¢ Hospedado na Vercel</div>
    </div>
  </footer>

  <!-- Modal de detalhes -->
  <dialog id="movieModal">
    <div class="modal-head">
      <strong id="mTitle">T√≠tulo</strong>
      <button id="mClose" class="pill">Fechar</button>
    </div>
    <div class="modal-body">
      <div class="row">
        <img id="mPoster" alt="" style="width:160px;height:auto;border-radius:10px;object-fit:cover">
        <div>
          <div id="mMeta" class="muted"></div>
          <div id="mGenres" style="margin-top:6px"></div>
        </div>
      </div>
      <div id="mOverview"></div>
    </div>
  </dialog>

  <script>
    const API = {
      tmdbMovie: (id) => `/api/tmdb/movie?id=${id}`,
    };
    const IMG = (p)=> p ? `https://image.tmdb.org/t/p/w342${p}` : "";
    const STORE_KEY = 'cinelista-store-v1';
    const $ = s => document.querySelector(s);
    function getStore(){ try{ return JSON.parse(localStorage.getItem(STORE_KEY)) || {fav:[],watched:[],watchlist:[]}; }catch{ return {fav:[],watched:[],watchlist:[]}; } }
    function setStore(s){ localStorage.setItem(STORE_KEY, JSON.stringify(s)); }
    function removeItem(status, id){ const s=getStore(); s[status]=s[status].filter(x=>x.id!==id); setStore(s); render(currentTab); }
    function counts(){ const s=getStore(); return {fav:s.fav.length, watched:s.watched.length, watchlist:s.watchlist.length}; }
    function setCounts(){ const c=counts(); $('#c-fav').textContent=c.fav; $('#c-watched').textContent=c.watched; $('#c-watchlist').textContent=c.watchlist; }

    async function showDetails(id){
      const r = await fetch(API.tmdbMovie(id)); if(!r.ok) return;
      const m = await r.json();
      $('#mTitle').textContent = m.title || m.name || 'Filme';
      $('#mPoster').src = IMG(m.poster_path);
      const year = m.release_date ? m.release_date.split('-')[0] : '';
      const runtime = m.runtime ? `${m.runtime} min` : '';
      const rating = (m.vote_average?.toFixed?.(1) ?? '‚Äî');
      $('#mMeta').textContent = [year, runtime, `‚≠ê ${rating}`].filter(Boolean).join(' ‚Ä¢ ');
      $('#mOverview').textContent = m.overview || 'Sem sinopse.';
      $('#mGenres').innerHTML = (m.genres||[]).map(g=>`<span class="tag">${g.name}</span>`).join('');
      $('#movieModal').showModal();
    }

    function row(item){
      return `
        <div class="item" data-id="${item.id}" data-status="${item.status}">
          <img src="${IMG(item.poster_path)}" alt="${item.title}" class="open">
          <div style="flex:1">
            <div class="title open">${item.title}</div>
            <div class="muted">${item.status}</div>
          </div>
          <button class="pill danger del">üóëÔ∏è Remover</button>
        </div>`;
    }

    function render(tab){
      const s = getStore();
      const arr = s[tab] || [];
      setCounts();
      $('#list').innerHTML = arr.length ? arr.map(row).join('') : '<div class="muted">Nada por aqui ainda.</div>';
    }

    // Tabs
    let currentTab = 'fav';
    document.addEventListener('click', (e)=>{
      if(e.target.classList.contains('tab')){
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        e.target.classList.add('active');
        currentTab = e.target.dataset.tab;
        render(currentTab);
      }
    });

    // Intera√ß√µes da lista
    $('#list').addEventListener('click', (e)=>{
      const item = e.target.closest('.item'); if(!item) return;
      const id = Number(item.dataset.id);
      const status = item.dataset.status;

      if(e.target.classList.contains('del')){
        removeItem(status, id);
      } else if(e.target.classList.contains('open') || e.target.classList.contains('title')){
        showDetails(id);
      }
    });

    // Modal
    $('#mClose').onclick = ()=> $('#movieModal').close();

    // Export / Import / Clear
    $('#btnExport').onclick = ()=>{
      const blob = new Blob([JSON.stringify(getStore(),null,2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'cinelista-backup.json'; a.click();
    };
    $('#fileImport').onchange = async (ev)=>{
      const f = ev.target.files?.[0]; if(!f) return; const text = await f.text();
      try{
        const s = JSON.parse(text);
        setStore({ fav:s.fav||[], watched:s.watched||[], watchlist:s.watchlist||[] });
        render(currentTab);
      }catch{}
    };
    $('#btnClear').onclick = ()=>{
      if(confirm('Apagar todas as listas locais?')){
        setStore({fav:[],watched:[],watchlist:[]}); render(currentTab);
      }
    };

    // Init
    (function(){ render(currentTab); })();
  </script>
</body>
</html>
