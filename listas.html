<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cinelista ‚Äî Minhas listas</title>

  <!-- CSP simples -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 img-src 'self' https://image.tmdb.org data:;
                 script-src 'self' 'unsafe-inline';
                 style-src 'self' 'unsafe-inline';
                 connect-src 'self'">

  <style>
    :root{
      --bg:#0b0d10;--panel:#13161a;--muted:#8fa1b3;--accent:#36d399;--danger:#e25555;--text:#e6edf3;--baseStar:#3a4755;
      --favBorder:#d8b40066;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial}
    header{position:sticky;top:0;z-index:10;background:rgba(11,13,16,.9);backdrop-filter:saturate(1.4) blur(6px);border-bottom:1px solid #1e2329}
    .wrap{max-width:1100px;margin:0 auto;padding:14px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    nav a{color:var(--muted);text-decoration:none;padding:8px 10px;border-radius:10px}
    nav a.active{color:var(--text);background:#0f1317;border:1px solid #2a323c}
    h1{margin:0;font-size:18px}

    .pan{background:var(--panel);border:1px solid #1e2329;border-radius:14px;padding:14px}
    .muted{color:var(--muted)}

    /* Bot√µes padr√£o (iguais ao index) */
    .btn{padding:8px 12px;border-radius:10px;border:1px solid #2a323c;background:#14181c;color:var(--text);font-weight:600;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    .btn-secondary{background:#0f1317}
    .btn-danger{border-color:#a33;background:#2a1517}

    /* Cabe√ßalho sess√£o */
    #loginBtn,#logoutBtn{border:1px solid #2a323c;background:#14181c;color:#e6edf3;padding:8px 12px;border-radius:10px;cursor:pointer}
    #loginBtn:hover,#logoutBtn:hover{filter:brightness(1.1)}
    #who{color:#8fa1b3}

    /* Abas */
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:8px 12px;border:1px solid #2a323c;background:#0f1317;border-radius:10px;cursor:pointer;color:var(--text)}
    .tab.active{border-color:var(--accent)}

    /* Grid */
    .movies{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:14px;margin-top:12px}
    .card{background:#0e1115;border:1px solid #1e2329;border-radius:12px;overflow:hidden}
    .thumb{position:relative}
    .poster{aspect-ratio:2/3;background:#0b0d10;display:block;width:100%;object-fit:cover;cursor:pointer;transition:filter .15s, outline-color .15s}
    .seen .poster{filter:brightness(.55) saturate(.85)}
    .fav .poster{outline:3px solid var(--favBorder)}
    .seen-text{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      color:#ffffffd0;font-weight:700;letter-spacing:.3px;text-shadow:0 1px 2px rgba(0,0,0,.6);pointer-events:none;opacity:0}
    .seen .seen-text{opacity:1}
    .body{padding:10px;display:grid;gap:8px}
    .title{font-weight:600;font-size:14px;cursor:pointer}
    .badge{font-size:12px;color:#a8b3bd}
    .actions{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .actions .btn-danger{font-size:12px}

    /* Estrelas maiores 0.5 */
    .stars{display:inline-flex;gap:8px;align-items:center;cursor:pointer}
    .star{font-size:24px;line-height:1;user-select:none;color:var(--baseStar);cursor:pointer;transition:transform .05s}
    .star.on{color:var(--accent)}
    .star.half{background:linear-gradient(90deg,var(--accent) 50%, var(--baseStar) 50%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .star:hover{transform:scale(1.1)}

    /* Modal */
    dialog{border:1px solid #2a323c;border-radius:14px;max-width:860px;width:calc(100% - 24px);background:#0e1115;color:var(--text)}
    dialog::backdrop{background:rgba(0,0,0,.6)}
    .modal-head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid #1e2329}
    .modal-body{display:grid;gap:12px;padding:14px}
    .tag{display:inline-block;padding:6px 10px;border:1px solid #2a323c;border-radius:999px;margin:0 6px 6px 0;font-size:12px;cursor:pointer;background:#14181c;color:#fff}
    .tag:hover{filter:brightness(1.07)}
    .tag.person{background:#14181c;color:#fff;border-color:#2a323c}
  </style>
</head>
<body>
  <header>
    <div class="wrap row" style="justify-content:space-between">
      <div class="row">
        <h1>üé¨ Cinelista</h1>
        <nav class="row">
          <a href="/">Explorar</a>
          <a class="active" href="/listas.html">Listas</a>
        </nav>
      </div>
      <div class="row" id="session">
        <span id="who" class="muted">N√£o logado</span>
        <button id="loginBtn">Entrar</button>
        <button id="logoutBtn" style="display:none">Sair</button>
      </div>
    </div>
  </header>

  <main class="wrap" style="margin-top:14px">
    <section class="pan">
      <div class="tabs">
        <button class="tab active" data-tab="fav">‚≠ê Favoritos (<span id="count-fav">0</span>)</button>
        <button class="tab" data-tab="watched">üëÅÔ∏è Assistidos (<span id="count-watched">0</span>)</button>
        <button class="tab" data-tab="watchlist">‚ûï Watchlist (<span id="count-watchlist">0</span>)</button>
      </div>
    </section>

    <section id="results" class="movies"></section>
  </main>

  <footer class="wrap" style="margin:24px 0">
    <div class="row" style="justify-content:space-between">
      <div>Dados de filmes por <a href="https://www.themoviedb.org/" target="_blank" rel="noopener">TMDB</a>. Este produto usa a API do TMDB, mas n√£o √© endossado por ela.</div>
      <div>Feito por <b>Werner</b> ‚Ä¢ Hospedado na Vercel</div>
    </div>
  </footer>

  <!-- Modal Detalhes -->
  <dialog id="movieModal">
    <div class="modal-head">
      <strong id="mTitle">T√≠tulo</strong>
      <button id="mClose" class="btn btn-secondary">Fechar</button>
    </div>
    <div class="modal-body">
      <div class="row" style="gap:14px;align-items:flex-start">
        <img id="mPoster" alt="" style="width:200px;height:auto;border-radius:10px;object-fit:cover">
        <div style="flex:1">
          <div id="mMeta" class="muted"></div>
          <div id="mGenres" style="margin-top:8px"></div>

          <div id="mCrew" style="margin-top:10px"></div>

          <div style="margin-top:12px">
            <div class="muted" style="margin-bottom:4px">Sua nota</div>
            <div id="mStars" class="stars"></div>
            <button id="mZero" class="btn btn-danger" style="margin-left:8px">Zerar nota</button>
          </div>
        </div>
      </div>
      <div id="mOverview" style="margin-top:8px"></div>
    </div>
  </dialog>

  <!-- Modal Auth -->
  <dialog id="authModal">
    <form id="authForm" method="dialog" style="display:grid;gap:10px;min-width:280px">
      <h3>Entrar / Registrar</h3>
      <input id="authUser" placeholder="usu√°rio (3-32, a-z 0-9 . _)" />
      <input id="authPass" type="password" placeholder="senha (6+)" />
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="doLogin">Entrar</button>
        <button id="doRegister" type="button">Registrar</button>
        <button id="authClose" type="button">Fechar</button>
      </div>
      <div id="authMsg" class="muted"></div>
    </form>
  </dialog>

  <script>
    // ========= Helpers / Store =========
    const STORE_KEY = 'cinelista-store-v1';
    const IMG = (p)=> p ? `https://image.tmdb.org/t/p/w342${p}` : "";
    const API = {
      tmdbMovie: (id)=> `/api/tmdb/movie?id=${id}`,
      tmdbCredits: (id)=> `/api/tmdb/credits?id=${id}`,
      tmdbPersonCredits: (id)=> `/api/tmdb/person_credits?id=${id}`,
    };
    function baseStore(){ return {fav:[],watched:[],watchlist:[],ratings:{}}; }
    function getStore(){ try{ const s=JSON.parse(localStorage.getItem(STORE_KEY))||baseStore(); if(!s.ratings) s.ratings={}; return s; }catch{ return baseStore(); } }
    function setStore(s){ localStorage.setItem(STORE_KEY, JSON.stringify(s)); }
    function setRating(id,val){ const s=getStore(); if(val>0) s.ratings[id]=val; else delete s.ratings[id]; setStore(s); }
    function removeItem(status, id){ const s=getStore(); s[status]=s[status].filter(x=>x.id!==id); setStore(s); }

    // ========= Sess√£o / Sincroniza√ß√£o com servidor =========
    const SESSION = { user:null };
    async function api(path, opts={}){ return fetch(path,{credentials:'include',...opts}); }
    async function whoami(){
      const r = await api('/api/auth/me'); const j = await r.json(); SESSION.user=j.user; updateSessionUI(); return j.user;
    }
    function updateSessionUI(){
      const w=document.getElementById('who'), inBtn=document.getElementById('loginBtn'), outBtn=document.getElementById('logoutBtn');
      if(SESSION.user){ w.textContent=`Logado como @${SESSION.user.username}`; inBtn.style.display='none'; outBtn.style.display=''; }
      else{ w.textContent='N√£o logado'; inBtn.style.display=''; outBtn.style.display='none'; }
    }
    let saveTimer;
    async function saveServerStore(){
      if(!SESSION.user) return;
      clearTimeout(saveTimer);
      saveTimer=setTimeout(async()=>{
        try{
          await api('/api/lists',{method:'PUT',headers:{'content-type':'application/json'},body:JSON.stringify({data:getStore()})});
        }catch{}
      },250);
    }
    const _setStoreReal=setStore;
    setStore=function(s){ _setStoreReal(s); saveServerStore(); };
    async function loadServerStore(){
      const r=await api('/api/lists'); if(!r.ok) return;
      const {data}=await r.json();
      if(data) localStorage.setItem(STORE_KEY, JSON.stringify(data));
      else await saveServerStore();
    }

    // ========= UI: Abas / Render =========
    let currentTab='fav';
    const $=s=>document.querySelector(s);

    function renderStars(el, movieId){
      const cur=Number(getStore().ratings[movieId]??0);
      el.innerHTML='';
      for(let i=1;i<=5;i++){
        const s=document.createElement('span');
        s.className='star';
        if(cur>=i) s.classList.add('on'); else if(cur>=i-0.5) s.classList.add('half');
        s.textContent='‚òÖ';
        s.addEventListener('mousemove',()=>{s.style.cursor='pointer';});
        s.addEventListener('click',(e)=>{
          const rect=e.target.getBoundingClientRect();
          const leftHalf=(e.clientX-rect.left)<rect.width/2;
          const val=leftHalf?(i-0.5):i;
          setRating(movieId,val);
          render(currentTab); // atualiza imediatamente na tela
        });
        el.appendChild(s);
      }
    }

    function card(item){
      const s=getStore();
      const year=''; // n√£o temos ano salvo; mostramos s√≥ t√≠tulo
      const isSeen = s.watched.some(x=>x.id===item.id);
      const isFav = s.fav.some(x=>x.id===item.id);
      const rating = s.ratings[item.id] ?? 0;

      return `
        <div class="card ${isSeen?'seen':''} ${isFav?'fav':''}" data-id="${item.id}">
          <div class="thumb">
            <img class="poster" loading="lazy" src="${IMG(item.poster_path)}" alt="${item.title}">
            <span class="seen-text">Visto</span>
          </div>
          <div class="body">
            <div class="title" data-open="1">${item.title||'Filme'}</div>
            <div class="badge">${year}</div>
            <div class="actions">
              <div class="stars" data-stars="${item.id}"></div>
              <button class="btn btn-danger" data-remove="${item.id}">Remover</button>
            </div>
          </div>
        </div>`;
    }

    function render(tab){
      currentTab=tab;
      document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active', t.dataset.tab===tab));
      const s=getStore();
      $('#count-fav').textContent = s.fav.length;
      $('#count-watched').textContent = s.watched.length;
      $('#count-watchlist').textContent = s.watchlist.length;

      const list = s[tab];
      $('#results').innerHTML = list.map(card).join('');
      // aplica estrelas
      list.forEach(it=>{
        const el = document.querySelector(`.stars[data-stars="${it.id}"]`);
        if(el) renderStars(el, it.id);
      });
    }

    // ========= Modal Detalhes =========
    async function showDetails(id){
      const [mRes,cRes] = await Promise.all([ fetch(API.tmdbMovie(id)), fetch(API.tmdbCredits(id)) ]);
      if(!mRes.ok){ alert('Erro ao carregar'); return; }
      const m = await mRes.json();
      const credits = cRes.ok ? await cRes.json() : {crew:[]};

      $('#mTitle').textContent = m.title || m.name || 'Filme';
      $('#mPoster').src = IMG(m.poster_path);
      const year = m.release_date ? m.release_date.split('-')[0] : '';
      const runtime = m.runtime ? `${m.runtime} min` : '';
      const rating = (m.vote_average?.toFixed?.(1) ?? '‚Äî');
      $('#mMeta').textContent = [year, runtime, `‚≠ê ${rating}`].filter(Boolean).join(' ‚Ä¢ ');
      $('#mOverview').textContent = m.overview || 'Sem sinopse.';

      // g√™neros
      $('#mGenres').innerHTML = (m.genres||[]).map(g=>`<span class="tag" data-genre="${g.id}">${g.name}</span>`).join('');

      // crew
      const crew = credits.crew || [];
      const dir = crew.filter(x=>x.job==='Director');
      const writers = crew.filter(x=>['Screenplay','Writer','Story','Adaptation'].includes(x.job));
      const editors = crew.filter(x=>x.job==='Editor');
      const peopleLine = (label, arr, role) =>
        arr.length ? `<div class="muted"><b>${label}:</b> ${arr.slice(0,8).map(p=>`<button class="tag person" data-person="${p.id}" data-role="${role}">${p.name}</button>`).join(' ')}</div>` : '';
      $('#mCrew').innerHTML = [ peopleLine('Dire√ß√£o',dir,'director'), peopleLine('Roteiro',writers,'writer'), peopleLine('Edi√ß√£o',editors,'editor') ].join('');

      // estrelas do modal (usa rating salvo)
      const el = document.getElementById('mStars');
      el.innerHTML='';
      const cur = Number(getStore().ratings[m.id] ?? 0);
      for(let i=1;i<=5;i++){
        const s=document.createElement('span'); s.className='star';
        if(cur>=i) s.classList.add('on'); else if(cur>=i-0.5) s.classList.add('half');
        s.textContent='‚òÖ';
        s.addEventListener('click',(e)=>{
          const rect=e.target.getBoundingClientRect();
          const leftHalf=(e.clientX-rect.left)<rect.width/2;
          const val=leftHalf?(i-0.5):i;
          setRating(m.id,val);
          showDetails(m.id); // re-render modal
          render(currentTab); // reflete na lista sem recarregar
        });
        el.appendChild(s);
      }
      document.getElementById('mZero').onclick = ()=>{ setRating(m.id,0); showDetails(m.id); render(currentTab); };

      document.getElementById('movieModal').showModal();
    }

    // Clique em tags do modal ‚Üí ir para index com filtros
    document.addEventListener('click', (e)=>{
      if(e.target?.dataset?.genre){
        const gid = e.target.dataset.genre;
        location.href = `/?genre=${gid}`;
      }
      if(e.target?.dataset?.person){
        const pid = e.target.dataset.person;
        const role = e.target.dataset.role || 'director';
        location.href = `/?person=${pid}&role=${role}`;
      }
    });

    // ========= Bindings =========
    function bind(){
      // troca de abas
      document.querySelector('.tabs').addEventListener('click', (e)=>{
        const t=e.target.closest('.tab'); if(!t) return;
        render(t.dataset.tab);
      });

      // a√ß√µes nos cards
      document.getElementById('results').addEventListener('click', async (e)=>{
        const card=e.target.closest('.card'); if(!card) return;
        const id=Number(card.dataset.id);

        if(e.target.matches('.poster,[data-open]')){ showDetails(id); return; }

        if(e.target.dataset.remove){
          const tab=currentTab;
          removeItem(tab, id);
          render(tab);
        }
      });

      // fechar modal
      document.getElementById('mClose').onclick=()=>document.getElementById('movieModal').close();
    }

    // ========= UI Auth (abre modal, login/registro) =========
    (function authUIListas(){
      window.addEventListener('DOMContentLoaded', ()=>{
        const modal = document.getElementById('authModal');
        const msg   = document.getElementById('authMsg');

        document.addEventListener('click', (e)=>{
          if (e.target && e.target.id === 'loginBtn') {
            e.preventDefault();
            msg.textContent='';
            if (modal?.showModal) modal.showModal(); else modal?.setAttribute('open','');
          }
          if (e.target && e.target.id === 'authClose') {
            e.preventDefault();
            if (modal?.close) modal.close(); else modal?.removeAttribute('open');
          }
        });

        const doLogin    = document.getElementById('doLogin');
        const doRegister = document.getElementById('doRegister');

        doLogin?.addEventListener('click', async (ev)=>{
          ev.preventDefault();
          msg.textContent="Entrando...";
          const u=document.getElementById('authUser').value.trim();
          const p=document.getElementById('authPass').value.trim();
          const r=await fetch('/api/auth/login',{method:'POST',credentials:'include',
            headers:{'content-type':'application/json'}, body:JSON.stringify({username:u,password:p})});
          const j=await r.json();
          if(!r.ok){ msg.textContent=j.error||'Erro ao entrar'; return; }
          modal?.close?.();
          await whoami(); await loadServerStore(); render(currentTab);
        });

        doRegister?.addEventListener('click', async ()=>{
          msg.textContent="Registrando...";
          const u=document.getElementById('authUser').value.trim();
          const p=document.getElementById('authPass').value.trim();
          const r=await fetch('/api/auth/register',{method:'POST',credentials:'include',
            headers:{'content-type':'application/json'}, body:JSON.stringify({username:u,password:p})});
          const j=await r.json();
          if(!r.ok){ msg.textContent=j.error||'Erro ao registrar'; return; }
          modal?.close?.();
          await whoami(); await loadServerStore(); render(currentTab);
        });

        document.getElementById('logoutBtn')?.addEventListener('click', async ()=>{
          await fetch('/api/auth/logout',{method:'POST',credentials:'include'});
          if (window.SESSION) SESSION.user=null;
          updateSessionUI();
        });
      });
    })();

    // ========= Init =========
    (async function(){
      bind();
      await whoami().then(async u=>{ if(u) await loadServerStore(); });
      render(currentTab);
    })();
  </script>
</body>
</html>
