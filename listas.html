<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cinelista ‚Äî Listas</title>

  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 img-src 'self' https://image.tmdb.org data:;
                 script-src 'self' 'unsafe-inline';
                 style-src 'self' 'unsafe-inline';
                 connect-src 'self'">

  <style>
    :root{--bg:#0b0d10;--panel:#13161a;--muted:#8fa1b3;--accent:#36d399;--danger:#e25555;--text:#e6edf3;--baseStar:#3a4755}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial}
    header{position:sticky;top:0;z-index:10;background:rgba(11,13,16,.9);backdrop-filter:saturate(1.4) blur(6px);border-bottom:1px solid #1e2329}
    .wrap{max-width:1100px;margin:0 auto;padding:14px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    nav a{color:var(--muted);text-decoration:none;padding:8px 10px;border-radius:10px}
    nav a.active{color:var(--text);background:#0f1317;border:1px solid #2a323c}
    h1{margin:0;font-size:18px}

    .grid{display:grid;gap:12px}
    .pan{background:var(--panel);border:1px solid #1e2329;border-radius:14px;padding:14px}
    .muted{color:var(--muted)}

    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:8px 12px;border:1px solid #2a323c;background:#0f1317;border-radius:10px;cursor:pointer;color:var(--text)}
    .tab.active{border-color:var(--accent)}

    /* Cart√µes existentes */
    .list{display:grid;gap:10px}
    .item{display:grid;grid-template-columns:80px 1fr auto;gap:10px;align-items:center;padding:10px;border:1px solid #1e2329;background:#0e1115;border-radius:10px}
    .thumb{position:relative}
    .poster{width:80px;aspect-ratio:2/3;object-fit:cover;border-radius:6px}
    .title{font-weight:600}
    .meta{color:#a8b3bd;font-size:12px}
    .actions{display:flex;gap:8px}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid #2a323c;background:#14181c;color:var(--text);font-weight:600;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    .btn-sm{padding:6px 10px;font-size:12px}
    .btn-danger{border-color:#a33;background:#2a1517}

    /* Tags (crew/g√™neros) ‚Äì j√° padronizadas */
    .tag{
      display:inline-block;
      padding:6px 10px;
      border:1px solid #2a323c;
      border-radius:999px;
      margin:0 6px 6px 0;
      font-size:12px;
      cursor:pointer;
      background:#14181c;   /* fundo neutro */
      color:#fff;           /* texto branco */
      appearance:none;      /* mant√©m neutro p/ pessoa */
      border-color:#2a323c;
    }
    .tag:hover{ filter:brightness(1.07); }

    /* Estrelas (0.5) */
    .stars{display:inline-flex;gap:8px;align-items:center;cursor:pointer}
    .star{font-size:24px;line-height:1;user-select:none;color:#3a4755;cursor:pointer;transition:transform .05s}
    .star.on{color:#36d399}
    .star.half{
      background:linear-gradient(90deg,#36d399 50%, #3a4755 50%);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text
    }
    .star:hover{transform:scale(1.08)}

    dialog{border:1px solid #2a323c;border-radius:14px;max-width:860px;width:calc(100% - 24px);background:#0e1115;color:var(--text)}
    dialog::backdrop{background:rgba(0,0,0,.6)}
    .modal-head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid #1e2329}
    .modal-body{display:grid;gap:12px;padding:14px}

    /* ===== Patch simples: estilo dos bot√µes de sess√£o como no index ===== */
    #loginBtn, #logoutBtn{
      border:1px solid #2a323c;
      background:#14181c;
      color:#e6edf3;
      padding:8px 12px;
      border-radius:10px;
      cursor:pointer;
    }
    #loginBtn:hover, #logoutBtn:hover{ filter:brightness(1.1); }
    #who{ color: var(--muted); }
  </style>
</head>
<body>
  <header>
    <div class="wrap row" style="justify-content:space-between">
      <div class="row">
        <h1>üé¨ Cinelista</h1>
        <nav class="row">
          <a href="/">Explorar</a>
          <a class="active" href="/listas.html">Listas</a>
        </nav>
      </div>
      <div class="row muted">Modo: <b>single-user</b></div>
      <div id="session" class="row">
        <span id="who" class="muted"></span>
        <button id="loginBtn">Entrar</button>
        <button id="logoutBtn" style="display:none">Sair</button>
      </div>
    </div>
  </header>

  <main class="wrap grid" style="margin-top:14px">
    <section class="pan grid" style="gap:12px">
      <div class="tabs">
        <button class="tab active" data-tab="fav">‚≠ê Favoritos (<b id="c-fav">0</b>)</button>
        <button class="tab" data-tab="watched">üëÅÔ∏è Assistidos (<b id="c-watched">0</b>)</button>
        <button class="tab" data-tab="watchlist">üìù Watchlist (<b id="c-watchlist">0</b>)</button>
        <span style="flex:1"></span>
        <button id="btnExportWatchlist" class="btn btn-sm">Exportar Watchlist (.txt)</button>
        <button id="btnClear" class="btn btn-danger btn-sm">Limpar tudo</button>
      </div>
      <div class="muted" id="note">Dica: clique no t√≠tulo/miniatura para ver detalhes e dar nota.</div>
    </section>

    <section id="list" class="list"></section>
  </main>

  <footer class="wrap" style="margin:24px 0">
    <div class="row" style="justify-content:space-between">
      <div>Dados de filmes por <a href="https://www.themoviedb.org/" target="_blank" rel="noopener">TMDB</a>. Este produto usa a API do TMDB, mas n√£o √© endossado por ela.</div>
      <div>Feito por <b>Werner</b> ‚Ä¢ Hospedado na Vercel</div>
    </div>
  </footer>

  <!-- Modal de detalhes (original da sua p√°gina) -->
  <dialog id="movieModal">
    <div class="modal-head">
      <strong id="mTitle">T√≠tulo</strong>
      <button id="mClose" class="btn">Fechar</button>
    </div>
    <div class="modal-body">
      <div class="row" style="gap:14px;align-items:flex-start">
        <img id="mPoster" alt="" style="width:200px;height:auto;border-radius:10px;object-fit:cover">
        <div style="flex:1">
          <div id="mMeta" class="muted"></div>
          <div id="mGenres" style="margin-top:8px"></div>
          <div id="mCrew" style="margin-top:10px"></div>
          <div style="margin-top:12px">
            <div class="muted" style="margin-bottom:4px">Sua nota</div>
            <div id="mStars" class="stars"></div>
            <button id="mZero" class="btn btn-danger" style="margin-left:8px">Zerar nota</button>
          </div>
        </div>
      </div>
      <div id="mOverview" style="margin-top:8px"></div>
    </div>
  </dialog>

  <!-- Modal de autentica√ß√£o (original, sem mudan√ßas visuais) -->
  <dialog id="authModal">
    <form id="authForm" method="dialog" style="display:grid;gap:10px;min-width:280px">
      <h3>Entrar / Registrar</h3>
      <input id="authUser" placeholder="usu√°rio (3-32, a-z 0-9 . _)" />
      <input id="authPass" type="password" placeholder="senha (6+)" />
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="doLogin">Entrar</button>
        <button id="doRegister" type="button">Registrar</button>
        <button id="authClose" type="button">Fechar</button>
      </div>
      <div id="authMsg" class="muted"></div>
    </form>
  </dialog>

  <script>
    // ===== fun√ß√µes e dados j√° existentes na sua p√°gina (listas) =====
    const STORE_KEY = "cinelista-store-v1";
    const IMG = (p)=> p ? `https://image.tmdb.org/t/p/w342${p}` : "";
    const API = {
      tmdbMovie: (id)=> `/api/tmdb/movie?id=${id}`,
      tmdbCredits: (id)=> `/api/tmdb/credits?id=${id}`
    };

    function baseStore(){ return { fav:[], watched:[], watchlist:[], ratings:{} }; }
    function getStore(){ try{ const s=JSON.parse(localStorage.getItem(STORE_KEY))||baseStore(); if(!s.ratings) s.ratings={}; return s; }catch{ return baseStore(); } }
    function setStore(s){ localStorage.setItem(STORE_KEY, JSON.stringify(s)); }
    function setRating(id,val){ const s=getStore(); if(val>0) s.ratings[id]=val; else delete s.ratings[id]; setStore(s); }
    function removeItem(status,id){ const s=getStore(); s[status]=s[status].filter(x=>x.id!==id); setStore(s); }

    function el(tag,attrs={},children=[]){
      const e=document.createElement(tag);
      Object.entries(attrs).forEach(([k,v])=> e.setAttribute(k,v));
      (Array.isArray(children)?children:[children]).filter(Boolean).forEach(c=> e.append(c));
      return e;
    }

    function itemRow(it){
      const s=getStore();
      const rating=s.ratings[it.id]??0;

      const row=el('div',{class:'item','data-id':it.id});
      const img=el('img',{class:'poster',src:IMG(it.poster_path),alt:it.title});
      const thumb=el('div',{class:'thumb'},img);
      const title=el('div',{class:'title', 'data-open':'1'}, it.title||'Filme');
      const meta=el('div',{class:'meta'}, '');
      const left=el('div',{},[title,meta]);

      const stars=el('div',{class:'stars'});
      for(let i=1;i<=5;i++){
        const sp=el('span',{class:'star'},'‚òÖ');
        if(rating>=i) sp.classList.add('on'); else if(rating>=i-0.5) sp.classList.add('half');
        sp.addEventListener('click',(e)=>{
          const rect=e.target.getBoundingClientRect();
          const leftHalf=(e.clientX-rect.left)<rect.width/2;
          const val=leftHalf?(i-0.5):i;
          setRating(it.id,val); render(currentTab);
        });
        stars.append(sp);
      }

      const del=el('button',{class:'btn btn-danger btn-sm','data-remove':it.id},'Remover');
      const actions=el('div',{class:'actions'},[stars,del]);

      row.append(thumb,left,actions);
      return row;
    }

    function renderList(list){
      const root=document.getElementById('list');
      root.innerHTML='';
      list.forEach(it=> root.append(itemRow(it)));
    }

    function updateCounters(){
      const s=getStore();
      document.getElementById('c-fav').textContent = s.fav.length;
      document.getElementById('c-watched').textContent = s.watched.length;
      document.getElementById('c-watchlist').textContent = s.watchlist.length;
    }

    let currentTab='fav';
    function render(tab){
      if(tab) currentTab=tab;
      updateCounters();
      const s=getStore();
      renderList(s[currentTab]);
    }

    // Detalhes no modal (mantido do seu arquivo)
    async function showDetails(id){
      const [mRes,cRes]=await Promise.all([ fetch(API.tmdbMovie(id)), fetch(API.tmdbCredits(id)) ]);
      if(!mRes.ok){ alert('Erro ao carregar'); return; }
      const m=await mRes.json();
      const credits=cRes.ok?await cRes.json():{crew:[]};

      document.getElementById('mTitle').textContent = m.title || m.name || 'Filme';
      document.getElementById('mPoster').src = IMG(m.poster_path);
      const year = m.release_date ? m.release_date.split('-')[0] : '';
      const runtime = m.runtime ? `${m.runtime} min` : '';
      const rating = (m.vote_average?.toFixed?.(1) ?? '‚Äî');
      document.getElementById('mMeta').textContent = [year, runtime, `‚≠ê ${rating}`].filter(Boolean).join(' ‚Ä¢ ');
      document.getElementById('mOverview').textContent = m.overview || 'Sem sinopse.';

      // G√™neros
      document.getElementById('mGenres').innerHTML = (m.genres||[]).map(g=>`<span class="tag" data-genre="${g.id}">${g.name}</span>`).join('');

      // Crew
      const crew = credits.crew || [];
      const dir = crew.filter(x=>x.job==='Director');
      const writers = crew.filter(x=>['Screenplay','Writer','Story','Adaptation'].includes(x.job));
      const editors = crew.filter(x=>x.job==='Editor');
      const peopleLine = (label, arr, role) =>
        arr.length ? `<div class="muted"><b>${label}:</b> ${arr.slice(0,8).map(p=>`<button class="tag" data-person="${p.id}" data-role="${role}">${p.name}</button>`).join(' ')}</div>` : '';
      document.getElementById('mCrew').innerHTML = [
        peopleLine('Dire√ß√£o',dir,'director'),
        peopleLine('Roteiro',writers,'writer'),
        peopleLine('Edi√ß√£o',editors,'editor')
      ].join('');

      // Estrelas no modal
      const stars=document.getElementById('mStars'); stars.innerHTML='';
      const cur=Number(getStore().ratings[m.id]??0);
      for(let i=1;i<=5;i++){
        const s=document.createElement('span'); s.className='star';
        if(cur>=i) s.classList.add('on'); else if(cur>=i-0.5) s.classList.add('half');
        s.textContent='‚òÖ';
        s.addEventListener('click',(e)=>{
          const rect=e.target.getBoundingClientRect();
          const leftHalf=(e.clientX-rect.left)<rect.width/2;
          const val=leftHalf?(i-0.5):i;
          setRating(m.id,val); showDetails(m.id); render(currentTab);
        });
        stars.append(s);
      }
      document.getElementById('mZero').onclick=()=>{ setRating(m.id,0); showDetails(m.id); render(currentTab); };

      document.getElementById('movieModal').showModal();
    }

    // Bindings originais (remover, abrir modal, abas, exportar, etc.)
    function bind(){
      document.querySelector('.tabs').addEventListener('click',(e)=>{
        const t=e.target.closest('.tab'); if(!t) return; render(t.dataset.tab);
      });

      document.getElementById('list').addEventListener('click',(e)=>{
        const row=e.target.closest('.item'); if(!row) return;
        const id=Number(row.dataset.id);
        if(e.target.matches('[data-open], .poster')){ showDetails(id); return; }
        if(e.target.dataset.remove){ removeItem(currentTab, id); render(currentTab); }
      });

      document.getElementById('mClose').onclick=()=>document.getElementById('movieModal').close();

      // Exportar watchlist (.txt)
      document.getElementById('btnExportWatchlist').onclick=()=>{
        const s=getStore().watchlist;
        const txt=s.map(x=>x.title).join('\n');
        const blob=new Blob([txt],{type:'text/plain;charset=utf-8'});
        const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='watchlist.txt'; a.click();
      };

      document.getElementById('btnClear').onclick=()=>{
        if(confirm('Limpar todas as listas locais?')){ setStore(baseStore()); render(currentTab); }
      };
    }
  </script>

  <script>
    /* ===== Sess√£o/Sync com servidor e PATCH SIMPLES do modal de login ===== */
    const SESSION = { user: null };
    async function api(path, opts={}) {
      const r = await fetch(path, { credentials: "include", ...opts });
      return r;
    }
    async function whoami() {
      const r = await api("/api/auth/me");
      const j = await r.json();
      SESSION.user = j.user;
      updateSessionUI();
      return SESSION.user;
    }
    function updateSessionUI() {
      const w = document.getElementById("who");
      const inBtn = document.getElementById("loginBtn");
      const outBtn = document.getElementById("logoutBtn");
      if (SESSION.user) {
        w.textContent = `Logado como @${SESSION.user.username}`;
        inBtn.style.display = "none"; outBtn.style.display = "";
      } else {
        w.textContent = "N√£o logado";
        inBtn.style.display = ""; outBtn.style.display = "none";
      }
    }
    async function loadServerStore() {
      const r = await api("/api/lists");
      if (!r.ok) return;
      const { data } = await r.json();
      if (data) {
        localStorage.setItem(STORE_KEY, JSON.stringify(data));
      } else {
        await saveServerStore();
      }
    }
    let saveTimer;
    async function saveServerStore() {
      if (!SESSION.user) return;
      clearTimeout(saveTimer);
      saveTimer = setTimeout(async ()=>{
        try {
          await api("/api/lists", {
            method: "PUT",
            headers: { "content-type": "application/json" },
            body: JSON.stringify({ data: getStore() })
          });
        } catch {}
      }, 250);
    }
    const _setStoreReal = setStore;
    setStore = function(s){ _setStoreReal(s); saveServerStore(); };

    /* >>> PATCH: bind do modal depois do DOM + fetch com JSON */
    (function bindAuthUI(){
      // Executa apenas quando todo o DOM existir (modal inclu√≠do)
      window.addEventListener('DOMContentLoaded', ()=>{
        const m = document.getElementById("authModal");
        const open = document.getElementById("loginBtn");
        const close = document.getElementById("authClose");
        const doLogin = document.getElementById("doLogin");
        const doRegister = document.getElementById("doRegister");
        const msg = document.getElementById("authMsg");

        open?.addEventListener("click", ()=>{ 
          msg.textContent=""; 
          if (m?.showModal) m.showModal(); else m?.setAttribute("open",""); 
        });
        close?.addEventListener("click", ()=> { if (m?.close) m.close(); else m?.removeAttribute("open"); });

        doLogin?.addEventListener("click", async (ev)=>{
          ev.preventDefault();
          msg.textContent = "Entrando...";
          const u = document.getElementById("authUser").value.trim();
          const p = document.getElementById("authPass").value.trim();
          const r = await api("/api/auth/login", { 
            method:"POST", 
            headers:{ "content-type":"application/json" },
            body: JSON.stringify({ username: u, password: p })
          });
          const j = await r.json();
          if (!r.ok) { msg.textContent = j.error || "Erro ao entrar"; return; }
          if (m?.close) m.close();
          await whoami();
          await loadServerStore();
          if (typeof render === "function") render(currentTab || "fav");
        });

        doRegister?.addEventListener("click", async ()=>{
          msg.textContent = "Registrando...";
          const u = document.getElementById("authUser").value.trim();
          const p = document.getElementById("authPass").value.trim();
          const r = await api("/api/auth/register", { 
            method:"POST", 
            headers:{ "content-type":"application/json" },
            body: JSON.stringify({ username: u, password: p })
          });
          const j = await r.json();
          if (!r.ok) { msg.textContent = j.error || "Erro ao registrar"; return; }
          if (m?.close) m.close();
          await whoami();
          await loadServerStore();
          if (typeof render === "function") render(currentTab || "fav");
        });

        document.getElementById("logoutBtn")?.addEventListener("click", async ()=>{
          await api("/api/auth/logout", { method: "POST" });
          SESSION.user = null;
          updateSessionUI();
        });
      });
    })();

    // Init
    (async function(){
      bind();
      await whoami().then(async u=>{ if(u) await loadServerStore(); });
      render(currentTab);
    })();
  </script>
</body>
</html>
